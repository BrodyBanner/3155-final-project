{% extends "base.html" %}

{% block title %}
QuickCal | Schedules
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col">
          <h2 class="text-center">Schedule Wizard</h2>
        </div>
      </div>
      <div class="row">
        <div class="col">
            <form method="POST" class="text-center mt-4">
                {{ form.hidden_tag() }}
                <div>
                    {{ form.name.label }}<br>
                    {{ form.name(size=32) }}<br>
                    {% for error in form.name.errors %}
                        <span style="color: red;">{{ error }}</span><br>
                    {% endfor %}
                </div>
                <div>
                    {{ form.start_date.label }}<br>
                    {{ form.start_date(size=10) }}<br>
                    {% for error in form.start_date.errors %}
                        <span style="color: red;">{{ error }}</span><br>
                    {% endfor %}
                </div>
                <div>
                    {{ form.start_time.label }}<br>
                    {{ form.start_time(size=8) }}<br>
                    {% for error in form.start_time.errors %}
                        <span style="color: red;">{{ error }}</span><br>
                    {% endfor %}
                </div>
                <div>
                    {{ form.end_date.label }}<br>
                    {{ form.end_date(size=10) }}<br>
                    {% for error in form.end_date.errors %}
                        <span style="color: red;">{{ error }}</span><br>
                    {% endfor %}
                </div>
                <div>
                    {{ form.end_time.label }}<br>
                    {{ form.end_time(size=8) }}<br>
                    {{ form.description.label }}<br>
                    {{ form.description(rows=5, cols=50) }}<br>
                    {% for error in form.description.errors %}
                        <span style="color: red;">{{ error }}</span><br>
                    {% endfor %}
                </div>
                <div>
                    {{ form.assignments.label }}<br>
                </div>
                <div id="assignments-container">
                    {% for choice in form.assignments %}
                        {{ choice }} {{ choice.label }}<br>
                    {% endfor %}
                    {% for error in form.assignments.errors %}
                        <span style="color: red;">{{ error }}</span><br>
                    {% endfor %}
                </div>
                <div>
                    <button type="submit">Create Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('end_time').addEventListener('change', updateAssignments);
        document.getElementById('start_date').addEventListener('change', updateAssignments);
        document.getElementById('end_date').addEventListener('change', updateAssignments);
        document.getElementById('start_time').addEventListener('change', updateAssignments);
    });
    
    function updateAssignments() {
        var start_date = document.getElementById('start_date').value;
        var end_date = document.getElementById('end_date').value;
        var start_time = document.getElementById('start_time').value;
        var end_time = document.getElementById('end_time').value;
    
        if (start_date === '' || end_date === '' || start_time === '' || end_time === '') {
        return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/get_assignments?start_date=' + start_date + '&end_date=' + end_date + '&start_time=' + start_time + '&end_time=' + end_time, true);
        xhr.onload = function () {
            if (xhr.status == 200) {
                var assignments = JSON.parse(xhr.responseText);
                updateAssignmentsCheckboxes(assignments);
            }
        };
        xhr.send();
    }
    
    function updateAssignmentsCheckboxes(assignments) {

        var assignmentsContainer = document.getElementById('assignments-container');
        assignmentsContainer.innerHTML = '';

        assignments.forEach(function (assignment) {
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'assignments';
            checkbox.value = assignment.id;
            checkbox.id = 'assignment_' + assignment.id;
            checkbox.disabled = false;

            var label = document.createElement('label');
            label.for = 'assignment_' + assignment.id;
            label.textContent = assignment.title;

            assignmentsContainer.appendChild(checkbox);
            assignmentsContainer.appendChild(label);
            assignmentsContainer.appendChild(document.createElement('br'));
        });
    }
</script>    
{% endblock %}